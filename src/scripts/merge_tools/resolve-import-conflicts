#!/bin/bash
# bash, not POSIX sh, because of "readarray".

# This script edits files to remove conflict markers related to Java imports.
# It works on all files given on the command line;
# if none are given, it works on all files in or under the current directory.

# This script is not a git mergetool.  A git mergetool is given the base, parent 1, and
# parent 2 files, all without conflict markers.
# However, this script can be run instead of a git mergetool, or after a git mergetool.

# Exit status is 1 if conflicts remain after running this script or if
# there is an error generated in some file.
# Exit status is 0 if there are no conflicts after running this script.

if [ "$#" -eq 0 ] ; then
  readarray -t files < <(grep -l -r '^<<<<<<< HEAD' .)
else
  files=("$@")
fi

SCRIPTDIR="$(cd "$(dirname "$0")" && pwd -P)"

status=0

for file in "${files[@]}" ; do
  if ! "${SCRIPTDIR}"/resolve-import-conflicts-in-file.py "$file" ; then
    echo "Error in $file"
    git merge --abort
    exit 1
  fi
done

# From https://stackoverflow.com/questions/41246415/
if git diff --exit-code -S '<<<<<<< HEAD' -S "=======" -S ">>>>>>> $(git name-rev --name-only MERGE_HEAD)" HEAD ; then
  exit 0
fi

echo "Conflict"
git merge --abort
exit 1

